<!DOCTYPE HTML> <html> <head> <meta charset="utf-8"> <title>dzhai › SQL Server发送邮件的存储过程</title> <meta name="author" content="dzhai"> <meta name="description" content="大翟"> <meta name="keywords" content="java,SQL"> <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"> <meta property="og:title" content="SQL Server发送邮件的存储过程"> <meta property="og:site_name" content="dzhai"> <meta property="og:image" content="undefined"> <link href="/favicon.png" rel="icon"> <link rel="alternate" href="/atom.xml" title="dzhai" type="application/atom+xml"> <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"> <script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?de86f16e85759414cb73dd76433ae1b7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();</script></head></html><body> <header id="header"><div class="meta inner"> <h1><a href="/">dzhai</a></h1> <h2 id="header-h2">宁静致远</h2> <nav id="main-nav"> <ul> <li><a href="/">首页</a></li> <li><a href="/archives">文章归档</a></li> <li><a href="/tags">标签</a></li> <li><a href="/links">友情链接</a></li> <li><a href="/about">关于</a></li> </ul> <div class="clearfix"></div> </nav> </div> <div class="clearfix"></div></header> <div id="content" class="inner"> <div id="main-col" class="alignleft"><div id="wrapper"><div id="toc" class="toc-article"> <strong class="toc-title">文章目录</strong> <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#note"><span class="toc-number">1.</span> <span class="toc-text">Note</span></a></li></ol> </div> <article class="post"> <div class="post-content"> <header> <h1 class="title">SQL Server发送邮件的存储过程</h1> <time datetime="2014-05-20T02:12:42.000Z">2014-05-20</time> </header> <div class="entry"> <p>&#x5BF9;&#x4E8E;DB&#x4E2D;&#x7684;&#x8D44;&#x6599;&#x53D8;&#x66F4;&#xFF0C;&#x6709;&#x65F6;&#x4F1A;&#x6709;&#x5BC4;Mail&#x901A;&#x77E5;&#x76F8;&#x5173;&#x4EBA;&#x5458;&#x7684;&#x9700;&#x6C42;&#x3002;&#x4E0B;&#x9762;&#x662F;&#x5B9E;&#x73B0;&#x8FD9;&#x4E00;&#x529F;&#x80FD;&#x7684;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;<br>1.&#x5EFA;&#x7ACB;&#x53D1;Mail&#x7684;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;<br><a id="more"></a><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">GO</span><br><span class="line"><span class="comment">/****** Object:  StoredProcedure [dbo].[sp_SendMail]    Script Date: 05/13/2014 15:17:52 ******/</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span> [dbo].[sp_SendMail] </span><br><span class="line">  @<span class="keyword">From</span> <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">&apos;abc@qq.com&apos;</span>, </span><br><span class="line">  @<span class="keyword">To</span> <span class="built_in">varchar</span>(<span class="number">2000</span>), </span><br><span class="line">  @Subject <span class="built_in">varchar</span>(<span class="number">2000</span>)=<span class="string">&apos;Test&apos;</span>, </span><br><span class="line">  @<span class="keyword">Body</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) =<span class="string">&apos;&apos;</span>,</span><br><span class="line">  @BCC <span class="built_in">varchar</span>(<span class="number">4000</span>) =<span class="string">&apos;&apos;</span>,</span><br><span class="line">  @SMTPServer <span class="built_in">varchar</span>(<span class="number">50</span>)=<span class="string">&apos;127.0.0.1&apos;</span>,</span><br><span class="line">  @SMTPServerport <span class="built_in">varchar</span>(<span class="number">10</span>)=<span class="string">&apos;25&apos;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************</span><br><span class="line">This stored procedure takes the parameters and sends an e-mail. All the mail configurations are hard-coded in the stored procedure. Comments are added to the stored procedure where necessary. References to the CDOSYS objects are at the following MSDN Web site: http://msdn.microsoft.com/library/default.asp?url=/ library/en-us/cdosys/html/_cdosys_messaging.asp</span><br><span class="line"> *******************************************/</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">Declare</span> @iMsg <span class="built_in">int</span> </span><br><span class="line">   <span class="keyword">Declare</span> @hr <span class="built_in">int</span> </span><br><span class="line">   <span class="keyword">Declare</span> @<span class="keyword">source</span> <span class="built_in">varchar</span>(<span class="number">255</span>) </span><br><span class="line">   <span class="keyword">Declare</span> @description <span class="built_in">varchar</span>(<span class="number">500</span>) </span><br><span class="line">   <span class="keyword">Declare</span> @<span class="keyword">output</span> <span class="built_in">varchar</span>(<span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--***** Create the CDO.Message Object *****</span></span><br><span class="line">EXEC @hr = sp_OACreate <span class="string">&apos;CDO.Message&apos;</span>, @iMsg <span class="keyword">OUT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--*****Configuring the Message Object *****</span></span><br><span class="line"><span class="comment">-- http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cdosys/html/_cdosys_schema_configuration_sendusing.asp</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;Configuration.fields (&quot;http://schemas.microsoft.com/cdo/configuration/smtpserver&quot;).Value&apos;</span>, @SMTPServer</span><br><span class="line"></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;Configuration.fields (&quot;http://schemas.microsoft.com/cdo/configuration/smtpserverport&quot;).Value&apos;</span>,@SMTPServerport</span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;Configuration.fields (&quot;http://schemas.microsoft.com/cdo/configuration/smtpauthenticate&quot;).Value&apos;</span>,<span class="string">&apos;1&apos;</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;Configuration.fields (&quot;http://schemas.microsoft.com/cdo/configuration/sendusing&quot;).Value&apos;</span>,<span class="string">&apos;2&apos;</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;Configuration.fields (&quot;http://schemas.microsoft.com/cdo/configuration/smtpauthenticate&quot;).Value&apos;</span>,<span class="string">&apos;0&apos;</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;Configuration.fields (&quot;http://schemas.microsoft.com/cdo/configuration/smtpaccountname&quot;).Value&apos;</span>,@<span class="keyword">From</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;Configuration.fields (&quot;http://schemas.microsoft.com/cdo/configuration/sendusername&quot;).Value&apos;</span>,@<span class="keyword">From</span></span><br><span class="line"><span class="comment">--EXEC @hr = sp_OASetProperty @iMsg, &apos;Configuration.fields (&quot;http://schemas.microsoft.com/cdo/configuration/sendpassword&quot;).Value&apos;,&apos;admin123&apos;</span></span><br><span class="line"></span><br><span class="line">EXEC @hr = sp_OAMethod @iMsg, <span class="string">&apos;Configuration.Fields.Update&apos;</span>, <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Set the e-mail parameters.</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;To&apos;</span>, @<span class="keyword">To</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;From&apos;</span>, @<span class="keyword">From</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;Subject&apos;</span>, @Subject</span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;Bcc&apos;</span>, @Bcc</span><br><span class="line"></span><br><span class="line"><span class="comment">-- If you are using HTML e-mail, use &apos;HTMLBody&apos; instead of &apos;TextBody&apos;.</span></span><br><span class="line"><span class="comment">--EXEC @hr = sp_OASetProperty @iMsg, &apos;HTMLbody&apos;, @Body</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">&apos;TextBody&apos;</span>, @<span class="keyword">Body</span></span><br><span class="line">EXEC @hr = sp_OAMethod @iMsg, <span class="string">&apos;Send&apos;</span>, <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Sample error handling.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> @hr &lt;&gt;<span class="number">0</span></span><br><span class="line">  <span class="keyword">select</span> @hr</span><br><span class="line">  <span class="keyword">BEGIN</span></span><br><span class="line">    EXEC @hr = sp_OAGetErrorInfo <span class="literal">NULL</span>, @<span class="keyword">source</span> <span class="keyword">OUT</span>, @description <span class="keyword">OUT</span></span><br><span class="line">    <span class="keyword">IF</span> @hr = <span class="number">0</span></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">SELECT</span> @<span class="keyword">output</span> = <span class="string">&apos; Source: &apos;</span> + @<span class="keyword">source</span></span><br><span class="line">        PRINT @<span class="keyword">output</span></span><br><span class="line">        <span class="keyword">SELECT</span> @<span class="keyword">output</span> = <span class="string">&apos; Description: &apos;</span> + @description</span><br><span class="line">        PRINT @<span class="keyword">output</span></span><br><span class="line">      <span class="keyword">END</span></span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line">        PRINT <span class="string">&apos; sp_OAGetErrorInfo failed.&apos;</span></span><br><span class="line">        <span class="keyword">RETURN</span></span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line">  <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Do some error handling after each step if you have to.</span></span><br><span class="line"><span class="comment">-- Clean up the objects created.</span></span><br><span class="line">EXEC @hr = sp_OADestroy @iMsg</span><br><span class="line"></span><br><span class="line"><span class="comment">--exec sp_SendMail @To=&apos;dli@quadranglesystems.com&apos;,@Body=&apos;test send email&apos;</span></span><br></pre></td></tr></table></figure></p> <p><strong>2.&#x8C03;&#x7528;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;</strong></p> <p>&#x5BF9;&#x4E8E;&#x6570;&#x636E;&#x53D8;&#x66F4;&#xFF0C;&#x53EF;&#x518D;Trigger&#x4E2D;&#x8C03;&#x7528;&#x8FD9;&#x4E00;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;&#x3002;&#x4E5F;&#x53EF;&#x4EE5;&#x5728;SQL Server Agent&#x4E2D;&#x5EFA;&#x7ACB;&#x4F5C;&#x4E1A;&#x6765;&#x8C03;&#x7528;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x4F20;&#x5165;&#x76F8;&#x5E94;&#x53C2;&#x6570;&#x5373;&#x53EF;&#x3002;<br>exec sp_send_mail &#x2018;&#x53D1;&#x4EF6;&#x8005;Email(&#x91C7;&#x7528;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;&#x4E2D;&#x5199;&#x5165;&#x7684;&#x90A3;&#x4E2A;Email)&#x2019;,&#x2019;&#x6536;&#x4EF6;&#x8005;&#x5217;&#x8868;&#xFF0C;&#x5404;Email&#x7528;&#x5206;&#x53F7;&#x9694;&#x5F00;&#x2019;,&#x2019;&#x4E3B;&#x9898;&#x2019;,&#x2019;&#x5185;&#x5BB9;&#x2019;</p> <p>&#x6CE8;&#xFF1A;&#x4EE5;&#x4E0A;&#x5B58;&#x50A8;&#x8FC7;&#x7A0B;&#x6709;&#x4E2A;&#x7F3A;&#x9677;&#xFF0C;&#x5373;@Body&#x5B9A;&#x4E49;&#x4E3A;varchar&#x7C7B;&#x578B;&#xFF0C;&#x800C;SQL Server&#x4E2D;varchar&#x7C7B;&#x578B;&#x957F;&#x5EA6;&#x6700;&#x5927;&#x662F;8000&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x4E00;&#x6B21;&#x6700;&#x591A;&#x53EA;&#x80FD;&#x53D1;&#x9001;8000&#x4E2A;&#x5B57;&#x7B26;&#x7684;&#x5185;&#x5BB9;&#x3002;</p> <h2 id="note"><a href="#Note" class="headerlink" title="Note"></a><strong>Note</strong></h2><p>&#x53EF;&#x80FD;&#x9700;&#x8981;&#x8BBE;&#x7F6E;&#x6570;&#x636E;&#x5E93;&#x5C5E;&#x6027; &#x53C2;&#x8003;&#x6587;&#x7AE0; 2,3<br><figure class="highlight cal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>&#xFF09;http://wenku.baidu.com/link?url=vWN_L_LszsP86So3Cldgy3VhhoJAQc50NAMcK21IZ7WNnrQAi0ezbcN5eZTHIUOsZ3L5j-Hhv0cH3hRdTLlMMx-vzbSojkL2lFYPfuaRXIm</span><br><span class="line"><span class="number">2</span>&#xFF09;http://sqlsolace.blogspot.com/<span class="number">2009</span>/<span class="number">09</span>/sql-server-blocked-access-<span class="keyword">to</span>-<span class="function"><span class="keyword">procedure</span>.<span class="title">html</span></span><br><span class="line">3&#xFF09;<span class="title">http</span>:</span>//www.mssqltips.com/sqlservertip/<span class="number">2875</span>/how-<span class="keyword">to</span>-allow-ad-hoc-updates-<span class="keyword">in</span>-sql-server-system-catalogs/</span><br><span class="line"><span class="number">4</span>&#xFF09;http://support.microsoft.com/kb/<span class="number">555287</span></span><br></pre></td></tr></table></figure></p> </div> <script type="text/javascript">function rewardButtonClick(){var e=document.getElementById("QR");"none"===e.style.display?e.style.display="block":e.style.display="none"}</script><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"> <div></div> <button id="rewardButton" disable="enable" onclick="rewardButtonClick()" style="cursor:pointer;border:0;outline:0;border-radius:100%;padding:0;margin:0;letter-spacing:normal;text-transform:none;text-indent:0;text-shadow:none"> <span onmouseover="this.style.color=&quot;rgb(236,96,0)&quot;,this.style.background=&quot;rgb(204,204,204)&quot" onmouseout="this.style.color=&quot;#fff&quot;,this.style.background=&quot;rgb(236,96,0)&quot" style="display:inline-block;width:70px;height:70px;border-radius:100%;line-height:81px;color:#fff;font:400 35px/75px microsofty;background:#ec6000">赏</span> </button> <div id="QR" style="display:none"> <div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/resource/images/reward/wechat.png" alt="翟春龙 WeChat Pay" style="width:200px;max-width:100%;display:inline-block"> <p>微信打赏</p> </div> <div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/resource/images/reward/alipay.png" alt="翟春龙 Alipay" style="width:200px;max-width:100%;display:inline-block"> <p>支付宝打赏</p> </div> </div> <div></div></div> <footer> <div class="alignleft"> <div class="categories"> <a href="/categories/SQL/">SQL</a> </div> </div> <div class="alignright"> <div style="z-index:1000000"> <div class="ds-share flat" data-thread-key="2014/05/20/sql_1/" data-title="SQL Server发送邮件的存储过程" data-content="" data-url="http://www.dzhai.net/2014/05/20/sql_1/"> <div class="ds-share-inline"> <ul class="ds-share-icons-16"> <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li> <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li> <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li> <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li> <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li> </ul> <div class="ds-share-icons-more"> </div> </div> </div> </div> </div> <div class="clearfix"></div> </footer> </div> </article> <section id="comment"> <!-- Duoshuo Comment BEGIN --> <div class="ds-thread" data-thread-key="2014/05/20/sql_1/"></div> <script type="text/javascript">var duoshuoQuery={short_name:"dzhai"};!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://static.duoshuo.com/embed.js",e.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script><!-- Duoshuo Comment END --></section></div></div><div class="clearfix"></div> </div> <footer id="footer"><div class="inner"><div class="alignleft"> <p> &copy; 2016 dzhai </p> <p> <a href="https://github.com/imbyron/hexo-theme-daisy">Theme</a> By <a href="http://googleyixia.com">Byron</a> based on <a href="https://github.com/willerce/hexo-theme-noderce">Noderce</a>. </p> </div> <div class="clearfix"></div></div></footer> <script type="text/javascript"></script></body>