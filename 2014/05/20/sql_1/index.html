<!DOCTYPE HTML> <html> <head> <meta charset="utf-8"> <title>dzhai › SQL Server发送邮件的存储过程</title> <meta name="author" content="dzhai"> <meta name="description" content="大翟"> <meta name="keywords" content="java,SQL"> <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"> <meta property="og:title" content="SQL Server发送邮件的存储过程"> <meta property="og:site_name" content="dzhai"> <meta property="og:image" content="undefined"> <link href="/favicon.png" rel="icon"> <link rel="alternate" href="/atom.xml" title="dzhai" type="application/atom+xml"> <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css"> <script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="//hm.baidu.com/hm.js?de86f16e85759414cb73dd76433ae1b7";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();</script></head></html><body> <header id="header"><div class="meta inner"> <h1><a href="/">dzhai</a></h1> <h2 id="header-h2">宁静致远</h2> <nav id="main-nav"> <ul> <li><a href="/">首页</a></li> <li><a href="/archives">文章归档</a></li> <li><a href="/links">友情链接</a></li> <li><a href="/about">关于</a></li> </ul> <div class="clearfix"></div> </nav> </div> <div class="clearfix"></div></header> <div id="content" class="inner"> <div id="main-col" class="alignleft"><div id="wrapper"><article class="post"> <div class="post-content"> <header> <h1 class="title">SQL Server发送邮件的存储过程</h1> <time datetime="2014-05-20T02:12:42.000Z">2014-05-20</time> </header> <div class="entry"> <p>对于DB中的资料变更，有时会有寄Mail通知相关人员的需求。下面是实现这一功能的一种方法<br>1.建立发Mail的存储过程<br><a id="more"></a><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">GO</span><br><span class="line"><span class="comment">/****** Object:  StoredProcedure [dbo].[sp_SendMail]    Script Date: 05/13/2014 15:17:52 ******/</span></span><br><span class="line"><span class="keyword">SET</span> ANSI_NULLS <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">SET</span> QUOTED_IDENTIFIER <span class="keyword">ON</span></span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span> [dbo].[sp_SendMail] </span><br><span class="line">  @<span class="keyword">From</span> <span class="built_in">varchar</span>(<span class="number">100</span>)=<span class="string">'abc@qq.com'</span>, </span><br><span class="line">  @<span class="keyword">To</span> <span class="built_in">varchar</span>(<span class="number">2000</span>), </span><br><span class="line">  @Subject <span class="built_in">varchar</span>(<span class="number">2000</span>)=<span class="string">'Test'</span>, </span><br><span class="line">  @<span class="keyword">Body</span> <span class="built_in">varchar</span>(<span class="number">4000</span>) =<span class="string">''</span>,</span><br><span class="line">  @BCC <span class="built_in">varchar</span>(<span class="number">4000</span>) =<span class="string">''</span>,</span><br><span class="line">  @SMTPServer <span class="built_in">varchar</span>(<span class="number">50</span>)=<span class="string">'127.0.0.1'</span>,</span><br><span class="line">  @SMTPServerport <span class="built_in">varchar</span>(<span class="number">10</span>)=<span class="string">'25'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************</span><br><span class="line">This stored procedure takes the parameters and sends an e-mail. All the mail configurations are hard-coded in the stored procedure. Comments are added to the stored procedure where necessary. References to the CDOSYS objects are at the following MSDN Web site: http://msdn.microsoft.com/library/default.asp?url=/ library/en-us/cdosys/html/_cdosys_messaging.asp</span><br><span class="line"> *******************************************/</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">Declare</span> @iMsg <span class="built_in">int</span> </span><br><span class="line">   <span class="keyword">Declare</span> @hr <span class="built_in">int</span> </span><br><span class="line">   <span class="keyword">Declare</span> @<span class="keyword">source</span> <span class="built_in">varchar</span>(<span class="number">255</span>) </span><br><span class="line">   <span class="keyword">Declare</span> @description <span class="built_in">varchar</span>(<span class="number">500</span>) </span><br><span class="line">   <span class="keyword">Declare</span> @<span class="keyword">output</span> <span class="built_in">varchar</span>(<span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--***** Create the CDO.Message Object *****</span></span><br><span class="line">EXEC @hr = sp_OACreate <span class="string">'CDO.Message'</span>, @iMsg <span class="keyword">OUT</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--*****Configuring the Message Object *****</span></span><br><span class="line"><span class="comment">-- http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cdosys/html/_cdosys_schema_configuration_sendusing.asp</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'Configuration.fields ("http://schemas.microsoft.com/cdo/configuration/smtpserver").Value'</span>, @SMTPServer</span><br><span class="line"></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'Configuration.fields ("http://schemas.microsoft.com/cdo/configuration/smtpserverport").Value'</span>,@SMTPServerport</span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'Configuration.fields ("http://schemas.microsoft.com/cdo/configuration/smtpauthenticate").Value'</span>,<span class="string">'1'</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'Configuration.fields ("http://schemas.microsoft.com/cdo/configuration/sendusing").Value'</span>,<span class="string">'2'</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'Configuration.fields ("http://schemas.microsoft.com/cdo/configuration/smtpauthenticate").Value'</span>,<span class="string">'0'</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'Configuration.fields ("http://schemas.microsoft.com/cdo/configuration/smtpaccountname").Value'</span>,@<span class="keyword">From</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'Configuration.fields ("http://schemas.microsoft.com/cdo/configuration/sendusername").Value'</span>,@<span class="keyword">From</span></span><br><span class="line"><span class="comment">--EXEC @hr = sp_OASetProperty @iMsg, 'Configuration.fields ("http://schemas.microsoft.com/cdo/configuration/sendpassword").Value','admin123'</span></span><br><span class="line"></span><br><span class="line">EXEC @hr = sp_OAMethod @iMsg, <span class="string">'Configuration.Fields.Update'</span>, <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Set the e-mail parameters.</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'To'</span>, @<span class="keyword">To</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'From'</span>, @<span class="keyword">From</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'Subject'</span>, @Subject</span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'Bcc'</span>, @Bcc</span><br><span class="line"></span><br><span class="line"><span class="comment">-- If you are using HTML e-mail, use 'HTMLBody' instead of 'TextBody'.</span></span><br><span class="line"><span class="comment">--EXEC @hr = sp_OASetProperty @iMsg, 'HTMLbody', @Body</span></span><br><span class="line">EXEC @hr = sp_OASetProperty @iMsg, <span class="string">'TextBody'</span>, @<span class="keyword">Body</span></span><br><span class="line">EXEC @hr = sp_OAMethod @iMsg, <span class="string">'Send'</span>, <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Sample error handling.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> @hr &lt;&gt;<span class="number">0</span></span><br><span class="line">  <span class="keyword">select</span> @hr</span><br><span class="line">  <span class="keyword">BEGIN</span></span><br><span class="line">    EXEC @hr = sp_OAGetErrorInfo <span class="literal">NULL</span>, @<span class="keyword">source</span> <span class="keyword">OUT</span>, @description <span class="keyword">OUT</span></span><br><span class="line">    <span class="keyword">IF</span> @hr = <span class="number">0</span></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line">        <span class="keyword">SELECT</span> @<span class="keyword">output</span> = <span class="string">' Source: '</span> + @<span class="keyword">source</span></span><br><span class="line">        PRINT @<span class="keyword">output</span></span><br><span class="line">        <span class="keyword">SELECT</span> @<span class="keyword">output</span> = <span class="string">' Description: '</span> + @description</span><br><span class="line">        PRINT @<span class="keyword">output</span></span><br><span class="line">      <span class="keyword">END</span></span><br><span class="line">    <span class="keyword">ELSE</span></span><br><span class="line">      <span class="keyword">BEGIN</span></span><br><span class="line">        PRINT <span class="string">' sp_OAGetErrorInfo failed.'</span></span><br><span class="line">        <span class="keyword">RETURN</span></span><br><span class="line">    <span class="keyword">END</span></span><br><span class="line">  <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Do some error handling after each step if you have to.</span></span><br><span class="line"><span class="comment">-- Clean up the objects created.</span></span><br><span class="line">EXEC @hr = sp_OADestroy @iMsg</span><br><span class="line"></span><br><span class="line"><span class="comment">--exec sp_SendMail @To='dli@quadranglesystems.com',@Body='test send email'</span></span><br></pre></td></tr></table></figure></p> <p><strong>2.调用存储过程</strong></p> <p>对于数据变更，可再Trigger中调用这一存储过程。也可以在SQL Server Agent中建立作业来调用，只需要传入相应参数即可。<br>exec sp_send_mail ‘发件者Email(采用存储过程中写入的那个Email)’,’收件者列表，各Email用分号隔开’,’主题’,’内容’</p> <p>注：以上存储过程有个缺陷，即@Body定义为varchar类型，而SQL Server中varchar类型长度最大是8000。也就是说一次最多只能发送8000个字符的内容。</p> <h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a><strong>Note</strong></h2><p>可能需要设置数据库属性 参考文章 2,3<br><figure class="highlight cal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>）http://wenku.baidu.com/link?url=vWN_L_LszsP86So3Cldgy3VhhoJAQc50NAMcK21IZ7WNnrQAi0ezbcN5eZTHIUOsZ3L5j-Hhv0cH3hRdTLlMMx-vzbSojkL2lFYPfuaRXIm</span><br><span class="line"><span class="number">2</span>）http://sqlsolace.blogspot.com/<span class="number">2009</span>/<span class="number">09</span>/sql-server-blocked-access-<span class="keyword">to</span>-<span class="function"><span class="keyword">procedure</span>.<span class="title">html</span></span><br><span class="line">3）<span class="title">http</span>:</span>//www.mssqltips.com/sqlservertip/<span class="number">2875</span>/how-<span class="keyword">to</span>-allow-ad-hoc-updates-<span class="keyword">in</span>-sql-server-system-catalogs/</span><br><span class="line"><span class="number">4</span>）http://support.microsoft.com/kb/<span class="number">555287</span></span><br></pre></td></tr></table></figure></p> </div> <footer> <div class="alignleft"> <div class="categories"> <a href="/categories/SQL/">SQL</a> </div> </div> <div class="alignright"> <div style="z-index:1000000"> <div class="ds-share flat" data-thread-key="2014/05/20/sql_1/" data-title="SQL Server发送邮件的存储过程" data-content="" data-url="http://www.dzhai.net/2014/05/20/sql_1/"> <div class="ds-share-inline"> <ul class="ds-share-icons-16"> <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li> <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li> <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li> <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li> <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li> </ul> <div class="ds-share-icons-more"> </div> </div> </div> </div> </div> <div class="clearfix"></div> </footer> </div> </article> <section id="comment"> <!-- Duoshuo Comment BEGIN --> <div class="ds-thread" data-thread-key="2014/05/20/sql_1/"></div> <script type="text/javascript">var duoshuoQuery={short_name:"dzhai"};!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="http://static.duoshuo.com/embed.js",e.charset="UTF-8",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}();</script><!-- Duoshuo Comment END --></section></div></div><div class="clearfix"></div> </div> <footer id="footer"><div class="inner"><div class="alignleft"> <p> &copy; 2016 dzhai </p> <p> <a href="https://github.com/imbyron/hexo-theme-daisy">Theme</a> By <a href="http://googleyixia.com">Byron</a> based on <a href="https://github.com/willerce/hexo-theme-noderce">Noderce</a>. </p> </div> <div class="clearfix"></div></div></footer> <script type="text/javascript"></script></body>